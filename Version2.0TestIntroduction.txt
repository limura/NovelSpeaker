ことせかい のβテストへの貢献ありがとうございます。
βテスタの方々にはいつも助けられております。いつもありがとうございます。

今回リリース予定となっております Version 2.0.0 の ことせかい は、
今までのリリースの物とは違って、かなり大掛かりな変更を伴う物となっております。
そのため、通常のβテストとは違い、最短でも一ヶ月程度のテスト期間を設けようと考えています。
そのため、βテスタの皆様にはまたお手数をおかけしてしまうことになってしまって申し訳ないのですが、βテストへのご協力をお願いいたします。

また、下記でもおすすめしておりますが、Version 2.0.0 の ことせかい を TestFlight からインストールする「前に」Version 1.* の ことせかい の「設定タブ」->「バックアップ用データの生成」->「完全バックアップ〜」で完全バックアップを生成して保存しておく事を重ねておすすめしておきます。


それでは、以下に Version 2.* について説明していきます。


* 内部データベースの変更とバックアップについて

Version 2.* では内部データベースを変更しました。

そのため、Version 1.* のデータが保存されている ことせかい に上書きの形で Version 2.* をインストールして起動すると、起動時に Version 1.* 用のデータベースから Version 2.* 用のデータベースへの書き換え処理が走ります。その後、Version 1.* 用のデータベースファイルは削除されます。
このため、一旦 TestFlight 経由で Version 2.* をインストールして起動した後に、AppStore から Version 1.* のバイナリを上書きでダウンロードし直してもデータは元には戻りません。

そのため、もし、Version 2.* の試用をやめて、Version 1.* に戻る事があると考えられるのであれば
Version 1.* の上で「設定タブ」->「バックアップ用データの生成」->「完全バックアップ〜」を使用して完全なバックアップをとっておく事をおすすめします。
また、Version 1.* で生成されたバックアップファイル(完全と軽量のどちらでも)は Version 2.* でも読み込むことができますが、Version 2.* で生成されたバックアップファイルは Version 1.* では読み込むことはできません。
そのため、なにか問題があって AppStore で配布されている Version 1.* に戻ろうと思う場合を考慮して
事前に Version 1.* の上でバックアップファイルを生成して保存しておくことをおすすめしておきます。


* iCloud による端末間同期について

Version 2.* では iCloud を利用した端末間同期を利用可能にしました。
こちらは、「設定タブ」->「iCloud 同期を使用する」をONにする事で利用が開始されます。
(利用するためには、ある程度の容量が余っているiCloudアカウントにサインインしている必要があります)
iCloud同期 をしている端末は、ことせかい 上のほぼ全ての変更を iCloud側 のストレージに保存(アップロード)することで、別の端末でも同様の変更を適用されるという動作をします。
そのため、インターネットに接続されていない端末では同期がうまく働きません。

また、iCloud側へのアップロードは逐次行っていますが、iCloud側からの変更点のダウンロードについては
不定期に行うようになっています。そのため、片方の端末での変更が瞬時に別の端末に伝わるというような動作はあまり期待しない方が良いかもしれません。
ただ、別のアプリに変えたりホーム画面に戻るなどして一旦バックグラウンドに回された後、再び ことせかい を開いてフォアグラウンドに入った時点で、明示的に iCloud側 の変更点を読み込もうとしますので、同期を早めたい場合は一旦ホーム画面に戻って再度 ことせかい を開くなどしてから、2,3秒眺めてみるとあるいは同期されるかもしれません。
なお、変更点が大量であったり、ネットワーク回線の調子が悪かったりするだけで同期が止まったりしますので、「同期がうまくいかない」という事は結構ありそうな気がしています。
とはいえ、ことせかい の実装ではそのような事を意識せずに同期されているのが期待されているような見た目になってしまっていますので、なにかおかしな動作をする場合は報告を上げておいて頂けると良いかもしれません。
(ただ、iCloud同期は不定期に行われますため、「これこれこういう状況」でおかしくなったと報告されても、同様の状況をこちらで再現する事が難しい場合が多そうな気が凄くしています。そのため、症状を再現することができずに何もできないという事になる率が凄く高いのではないかなぁと今から戦々恐々としている感じです)

他に、iCloud同期 をするために利用させていただいている IceCream というライブラリなのですが、
恐らくこの IceCream の中で何らかの問題があるらしく、iCloud側から新しいデータをダウンロードしている時にエラーでアプリが落ちるという症状が何度か見かけました。
これは一度に大量のデータをiCloud側からダウンロードしている時などによく起きるように見えるのですが、
原因が特定できておりませんために対応できていない問題となります。
iCloud 同期をOFFからONにして、iCloud上のデータを読み込んでいる時などの大量のデータをダウンロードしている時に突然 ことせかい が落ちてしまった場合には、めげずに再度起動させて試してみると通ったりしますのでそんな感じで回避しておいて頂けますと幸いです。

なお、iCloud側に保存されているデータを「設定アプリ」->「Apple ID」->「iCloud」->「ストレージを管理」->「ことせかい」と手繰って行った所で ことせかい に割り当てられているiCloud上のデータを削除しますと、iCloud での同期がうまく動かなくなります。このような状態になった時には「設定タブ」の「ルビはルビだけ読む」のON/OFFを10回以上変化させた時に下の方に追加される DEBUG セクション の「現在のデータを全て iCloud にアップロードする」を選択してください。別の方法としては、アプリをアンインストールした後に再インストールしてから iCloud同期 を ON にすることで利用可能になるはずです。


* ほぼ全てのsource codeを書き直しました

Version 2.* では Version 1.* で利用していた Objective-C のプログラムを Swift で書き直しました。
また、読み上げ関係の部分やダウンロード関係の部分など、アルゴリズムの書き換えも発生していますため、動作が変わっています。
そのため、見た目は似通っていても、期待した動作をしない部分があったりしそうな予感がしています。

という訳ですので、「なにか変な動作をしているな」と思ったら遠慮せずにガンガン報告を上げて頂けますと助かります。
といいますか、その「変な動き」のような物はお問い合わせが多くなる物になりますので、できればリリースする前に全てを潰しておきたいと考えていますため、積極的に報告を上げて頂けますと本当に助かりますのでよろしくお願いいたします。


* 新機能・変更点の案内

というわけで、色々動かないかもしれませんので気をつけて下さいねという後ろ向きな案内はこれにて終了として、ここからは新機能や変更点の案内をしていきます。
これらの機能を使ってみて「これが出来るんだったらこれも出来るんじゃない？」とか「これは解りにくいのでこういう形にした方が混乱が少なくなると思うよ」とか「これは入れてないんかい？！入れてくれー」とかそんな感じの前向き？な感じの報告を上げて頂けますと嬉しいです。

** 本棚画面の変更点

本棚画面では個々の小説名の左側に星型のマークがつき、そこを押す事で小説を「お気に入り」に登録する事ができるようになりました。
お気に入りに登録された小説は削除ができなくなり、更新確認時には優先的に確認を行うようになります。

また、本棚画面の右上にあります「順番」で選択できる項目が増えました。
例えば、「お気に入り順」を選択しますと、お気に入りに登録された小説が上に表示されるようになります。
また、「作者名順」を選択しますと、作者名でフォルダ分けされた形の表示となります。
自作フォルダを作っていれば「自作フォルダ順」を選択することでフォルダ毎に入れた小説を確認することができるようになります。

** なろう検索タブ を削除して、Web検索タブ を導入しました

なろう検索タブは 小説家になろう様 の小説の検索だけしかできなかったのですが、それ以外のWeb小説サイト様でも検索ができるような形の物として Web検索タブ を導入しました。
一番上の選択項目からそれぞれのWebサイト様を選択して出てくるフォームに入力して「検索」をすると、検索結果がリスト表示されますので、そこから仮読み込みを行って小説を取り込めるようにしています。
実験的に小説ではないWebサイト様も入れてみているのですが、「いらないかなー」とか「それならこれとか入らないの？」とかいったようなご意見がありましたら報告を上げて頂けますと幸いです。

なお、提供しているのは「検索」機能なので、単純な記事リストのような物は(やってできないことはなさそうな気もしなくもありませんが)対象にしづらいとお考え下さい。

** 発話周りの設定を少し複雑な形に変更しました

Version 1.* では「設定タブ」の「声質の設定」でほぼ全ての設定をしていたものを、Version 2.* では「発話設定」と「発話変更設定」に分けました。
これは、「発話設定」側で

・話者
・声の高さ
・速度

を指定した「話者」を設定して、その設定された話者を「発話変更設定」で「会話文」に割り当てる、という形にしたという事になります。

これにより、Siri(女性)話者を標準の話者として、Otoya(男性)話者を会話文の話者として設定する事ができるようになり、Version 1.* では声の高さだけでしかそれらを識別できなかったのが、男性と女声の話者として変化させるような事ができるようになります。

** 個々の小説毎の設定項目が増えました

小説の本文画面にて、右上に表示される「詳細」ボタンから、その小説についての設定を色々と変更できるようにしました。
変更できる点は以下のようになっています。

・標準の話者
・発話変更設定
・読みの修正
・更新確認を行わないかどうかのON/OFF
・フォルダへ分類
・お気に入り度合いの設定

標準の話者や発話変更設定を小説に対して行う事で、この小説では標準の話者をSiri(女性)で発話、別の小説ではOtoya(男性)で発話、といったような設定ができるようになります。

読みの修正を小説に対して行う事では、その小説でだけ現れる特殊な名前についての読みの修正を登録することで、別の小説に影響がでないまま、その小説では正しく(?)読み上げられる、といったような設定ができるようになります。

更新を行わないかどうかのON/OFF では、更新が終了した小説についてこれを ON にしておく事で、更新確認時に無駄な更新確認を行わないように設定することができます。

フォルダへ分類では、本棚画面でフォルダを使った分類を行うことができます。
ただ、フォルダへ分類するという行為としては、小説本文画面から「詳細」ボタンで遷移した先の画面からですとその小説のみの設定という事になりますので、「設定タブ」->「自作フォルダを編集する」で全ての小説に対してのフォルダ分類を行う方が使い勝手が良いかもしれません。

お気に入り度合いの設定では、小説のお気に入り度合いを設定できます。
お気に入り度合いは 0 から 100 までの数値を設定できます。1以上 がお気に入りと判定され、その小説を削除する事ができなくなり、更新確認時には優先的にダウンロードされるようになります。
また、本棚画面で「お気に入り順」の表示にした場合、お気に入り度合いが高い小説の方が上に表示されるようになります。

** 小説のダウンロード周りの挙動の変化

小説のダウンロードの挙動についても変化があります。
Version 1.* では同時には一つのダウンロードしか行っていませんでしたが、Version 2.* からは最大で5並列でダウンロードを試みるようになります。ただし、同じWebサイト様に対しては同時には一つのダウンロードしか行いません。そのため、複数のWebサイト様の小説を本棚に登録している方ではダウンロードが今までよりも早めに終わると思いますが、一つのWebサイト様の小説しか登録されていない方は全く恩恵はありません。

また、Version 2.* では、JavaScript が動作した後に本文が表示されるようなWebサイト様にも対応できるようになりました。そのため、例えば pixiv小説様 といったWebサイト様からの取り込みが動作するようになりました。
(ただ、例に挙げました pixiv小説様 なのですが、こちらのWebサイト様はかなり頻繁にHTMLの構造が変わりますため、不定期に取り込みが失敗するようになる事が観測されています。実際の所、年に2,3回位の頻度で取り込みができなくなるようなHTML構造の変化を観測しています)


** 小説本文画面の変更点

小説本文画面にもいくつかの機能が追加されています。

本文を長押しした時に出てくるメニューでは、「読み替え登録(この小説用)」と「読み替え後を確認」の二つの機能が追加されています。

「読み替え登録(この小説用)」で登録された読み替え設定は、その時開いていた小説だけに適用される枠として保存されます(これは小説の詳細画面から登録できるものと同じ物になります)。

「読み替え後を確認」では、選択された範囲がどのような文字列として読み上げられるかを確認することができます。例えば、「設定タブ」->「読み上げ時の間の設定」で「非推奨型」を選択している場合には、間の設定が設定されている文字が「_。_。_。」というような文字として読み替えられているのを確認出来ることでしょう。

次に、小説本文画面では右上に表示されますボタン群が多くなってきてしまったため、表示されるボタンを選択できるようにしました。これは「設定タブ」->「小説本文画面の右上に表示されるボタン群の編集」から編集することができます。表示順を変えたり、表示・非表示の切り替えを行うことができます。
また、設定で非表示にしたとしても、「詳細」ボタンで表示される小説の詳細画面で同様の機能を提供しておりますので、必要であれば「詳細」から機能を選択して下さい。


** 再生終了時の動作について

Version 1.* では「繰り返し再生」の項目だったものを、Version 2.* では「再生が末尾に達したときの動作」として拡張しました。
動作として選択できるのは以下の通りになっています。

1. そのまま停止する
2. 最初の章から再生し直す
3. 現在の章を再生し直す
4. お気に入りのうち未読の物を再生
5. 同じフィルだの小説のうち未読の物を再生

このうち、4. と 5. が新しい動作となります。
5. については、読み終わった小説が複数のフォルダに属していた場合にはどのフォルダの次の小説を読むかは不定となります。この動作について制御することは今の所はできません。


** 1ページのみの小説を読み込んだ時の分割機能について

1ページのみの小説を読み込んだ時に、予め定義された文字があった場合にはそこでページを分けて取り込む事ができるようにしました。これは例えば青空文庫のようなサイト様から取り込もうとした時に有効に作用します。

この機能が使う分割対象の文字列は、「設定タブ」->「テキスト分割文字列の設定〜」で設定することができます。
ここには予め青空文庫様の組版案内にありますページ分けの文字列などが登録されておりますので、恐らくは青空文庫様からの取り込みではそれなりの分割をして取り込む事ができるようになっていると思います。


** 「はじめに(ことせかい の使い方)」という文章を本棚に自動で追加されるようにしました

ことせかい の初回起動時や Version 2.* にアップデート時に、「はじめに(ことせかい の使い方)」という文章を本棚に登録するようにしました。
こちらは ことせかい を初めて使う方向けに、「とりあえず読み上げるための小説をダウンロードする」ような所からゆっくりと解説していくような内容になっています。
一応後々章を追加できるような形で書いておりますのでそのうち何かを追加するような事をするかもしれません。



何か他にも色々と追加したような気がするのですが、大枠は上記のような所かと思います。
更新履歴の Version 2.0.0 の項目
https://raw.githubusercontent.com/limura/NovelSpeaker/IceCream/NovelSpeaker/UpdateMemo.txt
はもう少し詳しい情報になっていると思われます。かなり重複する内容になっていると思いますが……


他に、現時点で把握している問題点や既に解決したもの、リリース時には含めない事にしたものなどといった項目について、GitHub のカンバンを使って管理しております。お手数をおかけしてしまうことになりますが、報告を上げて頂きます際には下記のカンバンにて言及されている物であれば、そこに書かれている以上の情報を付記するなどして情報の精度を上げるような報告をして頂けますと幸いです。
https://github.com/limura/NovelSpeaker/projects/1


また、今までのテスト結果報告では、かなりの頻度で返信を行っていたと思うのですが、今回のテストは相当数の不都合報告が寄せられる事が予想されており、その全てに返信はできないだろうと考えています。従いまして、返信がどうしても欲しいという場合にはお手数ですが「必ず返信が欲しい」という事をβテスト結果報告の中に含めておいて頂けますようお願い致します。

お手数をおかけすることになってしまいますが、Version 2.0.0 のテストへのご協力をよろしくお願いいたします。
