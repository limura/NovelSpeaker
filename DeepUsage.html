<!DOCTYPE html>
<html>
  <head>
    <title>ことせかい のディープな使い方</title>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <section id="main_content">
<h1>見るだけでは発見しづらい機能の解説</h1>
<hr />
<h3>目次</h3>
<ul>
        <li><a href="#Introduction">はじめに</a></li>
	<li><a href="#WebImport">SafariからのWeb取込</a></li>
	<li><a href="#ImportTextDocument">テキストファイル等の取り込み(ことせかい へコピー)</a></li>
	<li><a href="#PullUpdateOnBookshelf">本棚の「ひっぱって更新」</a></li>
	<li><a href="#SwipeInTheText">本文表示部での左右のスワイプ</a></li>
	<li><a href="#RemoteControlFromEarphone">イヤホンについたリモコンからの操作</a></li>
	<li><a href="#ControlCenterOperation">コントロールセンターでの再生中の再生位置変更</a></li>
	<li><a href="#SpeechModTips">読み替え辞書登録Tips</a></li>
	<li><a href="#SpeechDelaySetting">読み上げ時の間の設定について</a></li>
	<li><a href="#SpeechModListPrint">読み替え辞書のリストを取り出す</a></li>
	<li><a href="#ImportDividedSentences">巨大なテキストファイルの取り込み方</a></li>
</ul>

<hr />
<h3 id="Introduction">はじめに</h3>
<p>ことせかい の機能は、見れば発見できるように作ろうとしている(長押しや画面外からのスワイプなどの見えていない何かを使うようなものは極力避けたUIを実装しようとしている)のですが、それでも発見しづらい機能がいくつか存在してしまっています。このページではそれら気づかれにくい機能について解説することで、それらの機能が忘れ去られないようにしようかと思います。
</p>
<p>なお、このリストは開発者がテキトーに思いつくままに書いているため、全ての発見しづらい機能を網羅しているわけではありません。ですので、何か抜けている物があったり、これは開発者も気づいていないのではなかろうかと思ったりした「便利な使い方」などありましたら、お問い合わせフォーム等からこっそり教えて頂けると嬉しいです。
</p>

<hr /><h3 id="WebImport">SafariからのWeb取込</h3>
<p>ことせかい では Web取込 タブから小説を取り込む事ができますが、この Web取込 タブに登録されていないWebサイト様についても小説を取り込む事ができる事があります。
そのようなWebサイト様を一つひとつ Web取込 タブ側でなんとかして表示してブックマークに追加するというのも良いとは思うのですが、Web取込 タブのブラウザはいまいち使い勝手がよろしくありませんので、特に初期から登録されていないWebサイト様については Safari を使った方が楽だという時もあります。
そのような時にはこの Safari からの Web取込 の機能が便利に利用できるかと思います。
この Safari からの Web取込 の方法については、Web取込の解説ページの<a href="./WebImport.html#ImportFromSafari">Safari からの取込</a>に詳しく書かれておりますのでそちらをご参照ください。
</p>
<p>ちなみに、<a href="https://www.google.co.jp">google検索のページ</a>などもWeb取込側のブックマークに入れることは可能ですので便利に利用してください。
</p>

<hr /><h3 id="ImportTextDocument">テキストファイル等の取り込み(ことせかい へコピー)</h3>
<p>ことせかい はテキストファイルやリッチテキスト、PDFといった文書ファイルについて、その文書ファイルの中の文字列を取り込む機能があります。これは、iOS のシェア機能を使って実装されています。
例えば、メールに添付されたテキストファイルやDropbox等のオンラインストレージサービス等に保存されたファイルを読み込む場合、それらのファイルをシェアボタン(四角から上向きの矢印が出ているアイコン)を使ってシェアされる先として、「ことせかいへコピー」が出る場合にはそのファイルの中身をテキストファイルとして本棚に登録することができます。
</p>
<p>なお、初期状態ではシェアボタンで出てくるメニューに「ことせかいへコピー」が出てこないかもしれません。その場合はシェアボタンを押した時に出てくるリストのうち、カラーのアイコンの部分の一番右側にある「その他」を選択した時に出てくる「ことせかいへコピー」をONにしますと、シェアボタンからの「ことせかいへコピー」の機能が使えるようになると思います。(また、シェアメニューで「ことせかい へ読み込む」というボタンが出てくる事がありますが、こちらは Safari からの取り込み時の専用メニューになりますので恐らくは Safari 以外のアプリでは動作しませんので「ことせかいへ コピー」の方を押して下さい)
</p>
<p>なお、2019年2月現在、このようなシェアボタンを経由して ことせかい へと取り込む事ができるファイルは以下の拡張子のものになります。
<ul>
	<li>.txt</li>
	<li>.rtf, .rtfd</li>
	<li>.pdf</li>
</ul>
</p>

<hr /><h3 id="PullUpdateOnBookshelf">本棚の「ひっぱって更新」</h3>
<p>ことせかい では、小説が更新された場合にその新しく追加された章を読み込む機能がございます。
本棚を表示している時に右上にあります回転している矢印のアイコンをタップすることで全ての小説について更新の確認を行う事ができますが、小説のリストを一番上までスクロールして、そこからさらに下に向けてリストを引っ張る事でも、全ての小説についての更新の確認を行わせる事ができます。
右上の回転している矢印アイコンをタップするのが面倒くさい場合には少しだけ便利かもしれません。
</p>

<hr /><h3 id="SwipeInTheText">本文表示部での左右のスワイプ</h3>
<p>小説の本文を表示している時に、画面下部の「＜」と「＞」というアイコンをタップする事で前後の章へと移動できます。
ただ、この「＜」と「＞」を押すのが面倒くさいという場合には、本文部分を左右にスワイプすることでも、同様に前後の章へと移動することができるようになっています。
どちらか使いやすい方を使って頂ければと思います。
</p>

<hr /><h3 id="RemoteControlFromEarphone">イヤホンについたリモコンからの操作</h3>
<p>ことせかい はイヤホンからのリモートコントロールに対応しています。
イヤホンの種類によって操作が異なってしまいますのでこの操作でこうなる、という事を正確に言い表す事はできないのですが、例えばイヤホンジャックのついた iPhone に付属していたイヤホンについているリモコンからの操作ですと、以下のような事ができるようになっています。
<ul>
	<li>再生・停止：真ん中ボタンを一回押す</li>
	<li>次の章：真ん中ボタンを二回素早く押す</li>
	<li>前の章：真ん中ボタンを三回素早く押す</li>
	<li>早送り：真ん中ボタンを二回素早く押し、二回目は押しっぱなし</li>
	<li>巻き戻し：真ん中ボタンを三回素早く押し、三回目は押しっぱなし</li>
</ul>
</p>

<hr /><h3 id="ControlCenterOperation">コントロールセンターでの再生中の再生位置変更</h3>
<p>設定 → 「他のアプリで音楽が鳴っても止まらないように努力する〜」 がONになっていない場合には、読み上げ中にコントロールセンター(ロック画面や画面外の上か下からスワイプすると出てくるアレ)からの制御が可能です。標準状態では再生の停止や前後の章への移動が可能です。
</p>
<p>設定 → 「コントロールセンターでの前の章や次の章へのボタンを少し巻き戻し・少し進めるボタンへ変更する」をONにしますと、前後の章への移動はできなくなりますが、ちょっと聞き取りにくかったのでもう一度、といった時に便利な少し巻き戻しという操作ができるようになります。
</p>
<p>設定 → 「コントロールセンターに再生時間を表示する〜」をONにしますと、コントロールセンター上で現在読み上げている章のおおよその読み上げ時間が表示されるようになり、同時に表示される再生位置のゲージをつまんで動かすことで、再生位置を(大雑把ですが)移動させる事ができるようになります。
</p>

<hr /><h3 id="SpeechModTips">読み替え辞書登録Tips</h3>
<p>ことせかい での読み上げ(正確にはAVSpeechSynthesizerでの読み上げ)は、その「ことせかい」という名前の由来にもありますように、思いの外多くの読み間違いが起こります。この読み間違いを修正するために、設定 → 「読みの修正」という機能があるのですが、この読み替えを行わせるときの登録方法のヒントを書き下しておきますので参考にしてください。
</p>
<p>読み替え辞書が本文へと適用される時には、読み替え元の文字数が長い方が優先されます。例えば、「宇宙世紀」から「うちゅうせいき」への読み替えと、「宇宙」から「そら」への読み替えの二つが登録されている時に、「宇宙世紀0079」は「うちゅうせいき0079」へと読み替えられますが、「宇宙に移民」は「そらに移民」へと読み替えられます。
</p>
<p>読み替えは、読み上げに使われる文字列として読み替え先の文字に置き換わったものが使われる、という事を意識すると良いです。
これは、読み替えた文字列が前後の文字列と合わさる事で別の単語に変化してしまうのに気をつけると言い換えても良いかもしれません。
例えば「地雷」を「じらい」と読み替える設定があった場合に、「地雷原」は「じらい原」と読み替えられてしまい、発音としては「じらいはら」となってしまう場合があるかもしれない、という事を考えておいたほうが良いという事です。
この例の場合は「地雷」を「じらい」と登録した場合は「地雷原」を「じらいげん」と読み替えるものも別途登録しておいたほうが無難だと思われます。
</p>
<p>単語の読み替えは ひらがな よりカタカナへ読み替えさせた方が良い事が多いです。
これは、文章中にはカタカナよりも ひらがな の方がよく出てくるため、ひらがな への読み替えを登録していると、前後のひらがなにくっついて別の単語として認識されて読み上げ方が違うように読み上げられてしまう可能性が高まる事を気をつけているという物です。
読み替え先をカタカナにすることでカタカナ部分が別の単語として認識されやすくなるため、前後の ひらがな とくっついて別の単語として認識される可能性を減らせます。
もちろん、単語ではない部分についてはカタカナにせずに ひらがな のままの方が良い場合の方が多いので、単純にカタカナにすれば良いというわけではありません。
</p>
<p>「は」を「わ」と読み上げさせないようにするには、「歯」に読み替えさせるという手段がないこともありません。
ただ、「歯」が前後の文字列とくっついてしまって別の単語として認識されてしまうことで読みがおかしなことになる場合がありそうです。
この場合に「_歯_」といった形で前後に「_」をくっつけることで強制的に前後の文字とはくっつけずに認識させることができるようです。
ただ、このテクニックは iOS のアップデートで AVSpeechSynthesizer が更新されることで上手く動かなくなる可能性があるため、標準の辞書では使っておりません。ご利用の際は将来的におかしな動作になるかもしれないという事を理解した上でご利用下さい。
</p>
<p>しばらく前から読み替え辞書の登録時には正規表現での登録ができるようになりました。正規表現での読み替えには <a href="https://developer.apple.com/documentation/foundation/nsregularexpression">NSRegularExpression</a> を使っておりますので <a href="https://developer.apple.com/documentation/foundation/nsregularexpression#1661082">NSRegularExpression で利用できるオペレータ</a> のほとんどが利用可能です。また、読み替え先の文字列に <code>$1</code> や <code>$2</code> といった <a href="https://developer.apple.com/documentation/foundation/nsregularexpression#1661112">Template Matching Format</a> を利用することもできます。
</p>
<p>他に、正規表現ですと「ひらがな」や「カタカナ」、「漢字」といった文字集合に対しての指定もできるようになっています。それぞれ、
<ul>
	<li>ひらがな: <code>\p{Hiragana}</code>
	<li>カタカナ: <code>\p{Katakana}</code>
	<li>漢字: <code>\p{Han}</code>
</ul>
となっています。これらはUnicodeのプロパティ名を指定する識別子である \p{UNICODE PROPERTY NAME} を使った一例となります。なお、Unicodeのプロパティ名で指定される文字集合辺りの話はかなり深い話になります(例えば、なぜこの文字は \p{Han} に入っていないのかとかそもそもなぜ Han なのかとかなどなどネタは尽きないのですが正直枝葉末節すぎて書いてもしょうがないです)し、素人の私が誤解や間違いなく解説できるような事でもありませんのでこれ以上はご自身で調べて学習して頂けますと幸いです。
</p>
<p>他に、正規表現での読み替え指定がされている場合、読み上げを行う文章全体に対して正規表現マッチを行い、マッチした場合には「マッチした部分」から「読み替え先」への読み替え辞書を一時的に登録する、という事を行っています。そのため、読み替えで似た文字列があった場合は一番長い読み替え元の物が採用されるというルールで適用される「読み替え元」は正規表現でマッチした後のマッチした部分になるため、場合によっては推測しにくい挙動になることがありえますのでご注意下さい。
</p>
<hr /><h3 id="SpeechDelaySetting">読み上げ時の間の設定について</h3>
<p>設定 → 読み上げ時の間の設定 の設定項目について解説しておきます。
</p>
<p>読み上げの間の設定は、AVSpeechSynthesizer での読み上げでは「、」や「。」といった部分の間の開け方があまり期待通りな間が開かないというお問い合わせから導入したもので、これらの文字列について、間の開け方をどのくらいにするのか、という事を設定できるようにしたものです。
この間の開け方は、AVSpeechSynthesizer の機能を使った「標準型」と、AVSpeechSynthesizer の仕様のスキマを突いた「非推奨型」の二種類があります。
</p>
<p>「標準型」では、<a href="https://developer.apple.com/documentation/avfoundation/avspeechutterance">AVSpeechUtterance</a> の <a href="https://developer.apple.com/documentation/avfoundation/avspeechutterance/1619694-postutterancedelay">postUtteranceDelay</a> プロパティを使って間を表現しています。
この postUtteranceDelay は TimeInterval型 で間の時間を指定できるのですが、どうやらある値以下の時間を指定しても、そのある値程度の時間が間として開いてしまうようです。つまり、0.1秒とか0.2秒とかの短い時間は開いてくれるわけですが、0.01秒とかのもっと短い時間の指定をしても0.1秒の間が開いてしまう、という感じです。そのため、ある程度小さい値を指定しようとしても、それ以上の時間の間が開いてしまってあんまり句読点の間に使うには使いにくいのではないか、というものになっています。
</p>
<p>これに対して「非推奨型」は、「_。」という文字列を複数回くっつけた文字列を読み上げさせるという手法になっています。AVSpeechSynthesizer では「。」を読み上げるときに、かなり短い時間の間を開けてくれます。これは「標準型」での間の指定よりも短い時間の間を表現できるものです。そこで、「非推奨型」では「。_。_。_。」といった文字列を読み上げさせることで、「標準型」よりも細かい時間単位での間の表現をできるようにしています。ただ、この「_。」を連続して読み上げさせる事で間を開ける時間を制御できるというのはAVSpeechSynthesizerの仕様のスキマを突いた形になっていますので、将来的には使えなくなる可能性が結構あるかなぁと思いまして、「非推奨型」としているという事になります。
また、「標準型」では単位は秒なのですが、非推奨型では単位が回数、なのでそれぞれ単位が違ってきてしまうため、UI上では単位を表示していません。
</p>
<p>次に、間の設定での改行の扱いについて解説しておきます。
文章中に複数の改行が連続して現れる場合は、だいたいにおいて段落の切り替えなどが行われることになるため、間は結構開いてくれたほうが良い事が多いです。つまり、改行についても間の設定をできるようにしておいたほうが良いということになります。そこで、改行についても設定できるようにしようかなぁと思ったのですが、間を開ける対象を入力する部分に使っている UITextField を1行入力モードで動かしていると、改行文字を入力することができないのでした。そこで、改行については「<改行>」という文字が入力されていたら、それを改行文字に置き換えて解釈するというルールにしています。
</p>
<hr /><h3 id="SpeechModListPrint">読み替え辞書のリストを取り出す</h3>
<p>iOS 11 辺り(だったと思います)から標準機能として入った「ショートカット」という仕組み(アプリ？)を使って、ことせかい に保存されている読み替え辞書のリストを取り出すショートカットを作ってみました。
</p>
<blockquote><a href="https://www.icloud.com/shortcuts/1af7a6bea56b4bf6a3b427334e448ef2">ことせかい の軽量バックアップから読み替え辞書を抜き出す</a></blockquote>
<p>というものがそれなのですが、ちょっと使い方が分かりづらいと思いますので以下に解説しておきます。
</p>
<p>まず、このショートカットは ことせかい 側の「設定」→「再ダウンロード用データの生成」→「軽量バックアップを生成する〜」を選択することで生成される軽量バックアップのファイルが必要となります。恐らく「軽量バックアップを生成する〜」を選択した時にメールを送信するような画面になると思いますので、そのメールを自分宛てに送信するなどして生成されたバックアップファイルをあとで読み込めるようにしてください。今回はこの過程で生成されたバックアップデータに保存されている読み替え辞書の部分を取り出すことで、読み替え辞書のリストを印刷しようというのが目的となります。
</p>
<p>次に、先程のショートカット(<a href="https://www.icloud.com/shortcuts/1af7a6bea56b4bf6a3b427334e448ef2">ことせかい の軽量バックアップから読み替え辞書を抜き出す</a>)から、「ショートカットを取得」して自分の端末にショートカットを取り込みます。
<center><a href="images/SpeechModPull/IMG_0880.png"><img src="images/SpeechModPull/IMG_0880.png" height="300"></a><br>ショートカットを取り込む</center>
</p>
<p>次に、先程生成した軽量バックアップのファイルを開きます。メールアプリであればファイルのシェアメニューが開くと思います(Gmailアプリなどのアプリではシェアボタン(四角から上向きの矢印が出ているボタン)を押さないとシェアメニューは開かないかもしれません)。そのシェアメニューから「ショートカット」を選択してください。
<center><a href="images/SpeechModPull/IMG_0885.png"><img src="images/SpeechModPull/IMG_0885.png" height="300"></a><br>シェアメニューで「ショートカット」を選択</center>
「ショートカット」がリストに無い場合は一番右側にあります「その他」を選択して、「ショートカット」をONにすると出てくると思います。
</p>
<p>シェアメニューから「ショートカット」を選択すると、どのショートカットを実行するかを選択する画面になります。
<center><a href="images/SpeechModPull/IMG_0887.png"><img src="images/SpeechModPull/IMG_0887.png" height="300"></a><br>ショートカットの選択画面</center>
ここで、「ことせかい の軽量バックアップから読み替え辞書を抜き出す」を選択することで、軽量バックアップファイルから読み替え辞書部分だけを抜き出して表示することができます。
<center><a href="images/SpeechModPull/IMG_0888.png"><img src="images/SpeechModPull/IMG_0888.png" height="300"></a><br>読み替え辞書を抜き出した結果</center>
</p>
<p>抜き出した結果を書き換えても読み替え辞書への登録には使えませんが、iPhone の小さい画面で見るよりは大きく印刷して見られたほうが良い、というような場合には少しだけ便利に使えるかもしれませんね。
</p>
<hr /><h3 id="ImportDividedSentences">巨大なテキストファイルの取り込み方</h3>
<p>ことせかい はテキストファイルを取り込む機能があるのですが、巨大なテキストファイルだったとしても巨大な一つの章として取り込まれてしまうために、読み上げの開始時にとても時間がかかるなどの問題が発生することがあります。
この問題は複数の章に分けて登録することで回避することができるのですが、テキストファイルをそのまま取り込もうとしても一つの章としてしか取り込めないために回避することが難しい問題となっています。
</p>
<p>今回はこの問題に対して
<ul>
	<li>巨大なテキストファイルを指定の文字列で分割して</li>
	<li>ことせかい の完全バックアップファイルに偽装したファイルを生成した上で</li>
	<li>ことせかい にそれを読み込ませることで章分けのされた一つの小説として取り込ませる</li>
</ul>
という事をショートカットを使って行うという物になります。
</p>
<p>まず、いくつかの章に区切って読み込ませたい文章をUTF-8エンコーディングのテキストファイルとして作っておいてください。
その時に、章の区切りとして <code>[[改ページ]]</code> という文字列をテキスト中に入れておきます。この <code>[[改ページ]]</code> の部分で章が区切られて取り込まれます。(なお、UTF-8エンコーディングで保存されていないテキストファイルを使用した場合、正常に取り込めないと思われます)
</p>
<p>次に、お手元の iOS端末 で<a href="https://www.icloud.com/shortcuts/cbe98aa9b10b4dbcbb2edc8cdaa850b7">複数ページに分割して ことせかい へ読み込む</a>というショートカットを入手してください。
</p><p>
次に、ショートカットアプリを起動して、先程入手したショートカット(「複数ページに分割して ことせかい へ読み込む」)の設定を確認します。
設定を確認するには目的のショートカット(この場合は「複数ページに分割して ことせかい へ読み込む」)の右上にある丸のなかに「…」があるようなアイコンをタップして出てくる手順リストの画面でさらにその右上に出てくる「完了」の下にあるON/OFFスイッチが2つあるようなアイコンをタップすることで設定を書き換えられます。
このショートカット個別の設定の画面で、「共有シートに表示」がONになっていて、その下の「受け入れ種類」にファイルが選択されていることを確認してください。
ここまででショートカットアプリの設定は終了です。
</p><p>
次に、Dropbox などから <code>[[改ページ]]</code> という文字列で区切られたテキストファイルをシェアボタン(Dropboxの場合はエクスポート)で共有しようとしてください。
この時、シェアされるアプリなどのリスト(下側の白黒のものです)の中に ショートカット のアイコンが無い場合は、下側の白黒のリストを右にずらしていって、「…」(その他)というアイコンを選択して「ショートカット」をONにしてください。
シェアされる先に ショートカット を選択すると、先程設定した「複数ページに分割して ことせかい へ読み込む」のショートカットがリストに出てくると思いますので「複数ページに分割して ことせかい へ読み込む」を選択してください。
</p><p>
「複数ページに分割して ことせかい へ読み込む」を選択すると、「小説名を指定してください」というダイアログが出て小説名を入力させられますので、適切な名前に書き換えてOKを押してください。(ここで改行を入れてしまうと正しく動作しませんので改行は入れないようにしてください)
</p><p>
小説名を入力してOKを押した後は、<code>[[改ページ]]</code>ごとに区切られたテキストファイルを生成して、それらを「ことせかい の完全バックアップファイルに偽装したファイル」にまとめた上で ことせかい へ読み込ませようとします。
ここの部分は文章が長ければ長いほど時間がかかると思いますので気長に待っていただければと思います。
</p><p>
「ことせかい の完全バックアップファイルに偽装したファイル」が生成できますと ことせかい が起動してバックアップからの上書き追加の手順に入ります。
こちらも文章が長ければ長いほど時間がかかると思いますので気長に待っていただければ幸いです。
</p><p>
何事もつつがなく終了しますと、本棚に先程入力した小説名として小説が追加されているはずです。
</p>
	</section>
        <footer>
	  <a href="./">Top</a><br>
          ことせかい is maintained by <a href="https://github.com/limura">limura</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>
      </div>
    </div>
  </body>
</html>
